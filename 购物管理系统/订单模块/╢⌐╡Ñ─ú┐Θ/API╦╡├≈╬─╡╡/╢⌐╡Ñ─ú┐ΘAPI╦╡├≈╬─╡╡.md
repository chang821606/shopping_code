# 				订单模块API说明文档

## 一、概述:

此为达达商城订单功能模块API说明文档,此文档对于常规业务逻辑的流程进行分析和流程的流程中制定和针对订单模块的技术点进行分析。

## 二、事件定义

### 1.确认订单

用户在购物车页面点击确认**去结算**按钮，前端跳转到确认订单页(orderconfirm.html)发送Ajax请求(get)到后端，后端从redis中获取**商品信息**和mysql中获取**用户地址信息**响应给到订单确认页展示。

`点击去结算按钮`

![](事件定义_购物车结算.png)

`确认订单页展示数据`

![](确认订单页展示信息.png)

### 2.生成订单

用户在确认订单页面点击**确认并付款**按钮，前端跳转到支付订单页(payment.html)发送Ajax请求(post)到后端,后端生成订单且将**订单编号、订单状态（默认为待支付)、订单金额**等信息响应给前端订单支付页展示.此次请求带回第三方支付的URL.

`点击确认并付款按钮`

![](确认订单页_确认并付款.png)

`订单支付页展示`

![](订单支付页_数据展示.png)

### 3.第三方支付重定向及回调

用户在支付订单页点击**确认支付**按钮，前端获取事件使用**window.location**去访问第三方支付**pay_URL**,之后由支付宝提供支付业务。支付完成支付宝重定向到订单支付结果页面,并异步通知到商城后端。双重验证后返回支付结果给前端展示.

`点击确认订单按钮`

![](订单支付_确认支付事件.png)

`支付宝业务处理时序图`

![](支付宝交互时序图.png)

`支付结果展示`

![](支付结果.png)

### 4.订单查询

用户在页面头部点击**我的订单图标,**前端跳转到**我的订单页**(Myorder.html)发送Ajax请求(get)到后端,后端查询订单数据相应给前端.前端展示依据订单的状态**全部订单、待付款、待发货、待收货、已完成**进行展示数据即**订单编号、订单金额、成交时间和交易状态**。

`全部订单`

![](全部订单.png)

`待付款`

![](待付款.png)

`待发货`

![](待发货.png)

`待收货`

![](待收货.png)

`已完成`

![](已完成.png)

### 5.确认收货

用户在我的订单页面点击确认收货,前端获取点击事件向后端发送请求(get).后端将订单状态改为4，响应200.

`点击确认收货`

![](确认收货按钮.png)

### ６.订单支付

用户在我的订单页面点击**去支付**按钮，前端跳转到支付订单页(payment.html)发送Ajax请求(post)到后端,后端生成订单且将**订单编号、订单状态（默认为待支付)、订单金额**等信息响应给前端订单支付页展示.此次请求带回第三方支付的URL.

`此请求与订单生成支付相同`

## 三、API说明

### 1.确认订单API

#### 1.请求:

- **URL：**http://127.0.0.1:8000/v1/orders/processing/

- **请求方式:**GET

- **请求参数:**

|    参数    | 类型 | 是否必须 | 说明       |
| :--------: | :--: | :------: | ---------- |
|   status   | int  |    是    | 业务类型码 |
| settlement | int  |    是    | 结算类型   |

- **请求示例:**

```python
127.0.0.1:8000/v1/orders/processing/?status=0
```

#### 2.响应:

- **返回值类型:**JSON

- **响应内容:**

  | 字段  | 含义     | 类型 | 备注                        |
  | ----- | -------- | ---- | --------------------------- |
  | code  | 状态码   | int  | 默认正常为200，异常见状态码 |
  | data  | 具体数据 | dict | 与error二选一               |
  | error | 错误信息 | char | 与data二选一                |

- **响应格式:**

  ```python
  {"code":200,"data":data}
  ```

- **data参数信息:**

  |      参数      |   类型   | 是否必须 |       说明       |
  | :------------: | :------: | :------: | :--------------: |
  |   addresses    |   list   |    是    | 用户收货地址列表 |
  |    sku_list    |   list   |    是    |     商品信息     |
  |  total_count   |   int    |    是    |    商品总数量    |
  |  total_amount  | decimail |    是    |      总价格      |
  |    transit     |   int    |    是    |       运费       |
  | payment_amount | decimal  |    是    |      实付款      |

- **data数据示例:**

  ```python
     [{"addresses":[],
        "sku_list":[],
        "total_count":2,
        "total_amount":100.00,
        "transit":10,
        "payment_amount":110
        }]
  ```

- **error参数信息:**

  |   参数    | 类型 | 是否必须 |     说明     |
  | :-------: | :--: | :------: | :----------: |
  | error_msg | str  |    是    | 错误信息说明 |

- **error数据示例:**

  ```python
   [{
       "error_msg":""
   }]
  ```

- **状态码参考:**

  | 状态码 | 响应信息           |
  | ------ | ------------------ |
  | 200    | 正常               |
  | 50100  | 用户未添加收货地址 |

### 2.生成订单API

#### 1.请求

- **URL：**http://127.0.0.1:8000/v1/orders/processing/

- **请求方式:**POST

- **请求参数:**

|    参数    | 类型 | 是否必须 | 说明       |
| :--------: | :--: | :------: | ---------- |
|   status   | int  |    是    | 业务类型码 |
| address_id | int  |    是    | 收获地址id |

- **请求示例:**

```python
http://127.0.0.1:8000/v1/orders/processing/?status=0&address_id=1
```

#### 2.响应:

- **返回值类型:**JSON

- **响应内容:**

  | 字段  | 含义     | 类型 | 备注                        |
  | ----- | -------- | ---- | --------------------------- |
  | code  | 状态码   | int  | 默认正常为200，异常见状态码 |
  | data  | 具体数据 | dict | 与error二选一               |
  | error | 错误信息 | char | 与data二选一                |

- **响应格式:**

  ```python
  {"code":200,"data":data}
  ```

- **data参数信息:**

  |     参数     |   类型   | 是否必须 |      说明      |
  | :----------: | :------: | :------: | :------------: |
  |    saller    |   str    |    是    |    商家名称    |
  | total_amount | decimail |    是    |     总价格     |
  |   order_id   |   str    |    是    |     订单号     |
  |   pay_url    |   str    |    是    | 第三方支付路由 |

- **data数据示例:**

  ```python
     [{'saller': '达达商城',
       'total_amount': total_amount + 10,
       'order_id': order_id,
       'pay_url': pay_url
        }]
  ```

- **error参数信息:**

  |   参数    | 类型 | 是否必须 |     说明     |
  | :-------: | :--: | :------: | :----------: |
  | error_msg | str  |    是    | 错误信息说明 |

- **error数据示例:**

  ```python
   [{
       "error_msg":""
   }]
  ```

- **状态码参考:**

  | 状态码 | 响应信息            |
  | ------ | ------------------- |
  | 200    | 正常                |
  | 50104  | 操作太快,清扫后重试 |
  | 50103  | 商品X库存不足       |
  | 50102  | 收货地址无效        |

### 3.第三方支付重定向路由API

#### 1.请求

- **URL：**http://127.0.0.1:8000/v1/orders/success/

- **请求方式:**GET

- **请求参数:**

  |     参数     |  类型   | 是否必须 | 说明     |
  | :----------: | :-----: | :------: | -------- |
  | out_trade_no |   str   |    是    | 订单号   |
  | total_amount | decimal |    是    | 订单金额 |
  |     sign     |   str   |    是    | 密钥     |

- **请求示例:**

```python
http://127.0.0.1:8000/v1/orders/success/
```

#### 2.响应:

- **返回值类型:**重定向

- **响应内容:**

  | 字段         | 类型 | 备注       |
  | ------------ | ---- | ---------- |
  | status       | int  | 支付状态   |
  | order_id     | str  | 订单id     |
  | total_amount | int  | 订单总金额 |

- **响应格式:**

  ```python
  http://127.0.0.1/dadashop/templates/pay_success.html？status=1&order_id=2019111817303802&total_amount=219
  ```

- **status参数:**

| 数值 |   意义   |
| :--: | :------: |
|  1   | 支付成功 |
|  2   | 支付失败 |

### 4.第三方支付回调路由API

#### 1.请求

- **URL：**http://127.0.0.1:8000/v1/orders/success/

- **请求方式:**GET

- **请求参数:**

  |     参数     | 类型 | 是否必须 | 说明         |
  | :----------: | :--: | :------: | ------------ |
  | out_trade_no | str  |    是    | 订单号       |
  | trade_status | str  |    是    | 订单支付状态 |
  |     sign     | str  |    是    | 密钥         |

#### 2.响应

- **返回值类型:**字符串
- **响应内容:**"success"

### 5.订单查询API

#### 1.请求:

- **URL：**http://127.0.0.1:8000/v1/orders/processing/

- **请求方式:**GET

- **请求参数:**

|     参数     | 类型 | 是否必须 | 说明       |
| :----------: | :--: | :------: | ---------- |
|    status    | int  |    是    | 业务类型码 |
| order_status | str  |    是    | 订单状态   |

- **请求示例:**

```python
127.0.0.1:8000/v1/orders/processing/?status=1&order_status=0
```

#### 2.响应:

- **返回值类型:**JSON

- **响应内容:**

  | 字段  | 含义     | 类型 | 备注                        |
  | ----- | -------- | ---- | --------------------------- |
  | code  | 状态码   | int  | 默认正常为200，异常见状态码 |
  | data  | 具体数据 | dict | 与error二选一               |
  | error | 错误信息 | char | 与data二选一                |

- **响应格式:**

  ```python
  {"code":200,"data":data}
  ```

- **data参数信息:**

  |    参数     | 类型 | 是否必须 |     说明     |
  | :---------: | :--: | :------: | :----------: |
  | orders_list | list |    是    | 订单信息列表 |

- **data数据示例:**

  ```python
     "data":{"orders_list":[
                 {"order_id":"2019111811504601",
                  "order_total_count":1,
                  "order_total_amount":"209.00",
                  "order_freight":"1.00",
                  "address":{
                      "title":"家",
                      "address":"北京市北京市市辖区东城区珍贝大厦",
                      "mobile":"13691433520",
                      "receiver":"习多多"},
                  "status":1,
                  "order_sku":[
                         {"id":4,
                          "default_image_url":"2_940nDrI.jpg",
                          "name":"红袖添香",
                          "price":"199.00",
                          "count":1,
                          "total_amount":"199.00",
                          "sku_sale_attr_names":[
                              "颜色",
                              "尺寸"],
                          "sku_sale_attr_vals":[
                              "红色",
                              "15寸" ]}],
                  "order_time":"2019-11-18 11:50:46"}]}
  ```

- **error参数信息:**

  |   参数    | 类型 | 是否必须 |     说明     |
  | :-------: | :--: | :------: | :----------: |
  | error_msg | str  |    是    | 错误信息说明 |

- **error数据示例:**

  ```python
   [{
       "error_msg":""
   }]
  ```

- **状态码参考:**

  | 状态码 | 响应信息 |
  | ------ | -------- |
  | 200    | 正常     |

### 6.确认收货API

#### 1.请求:

- **URL：**http://127.0.0.1:8000/v1/orders/processing/

- **请求方式:**GET

- **请求参数:**

|   参数   | 类型 | 是否必须 | 说明       |
| :------: | :--: | :------: | ---------- |
|  status  | int  |    是    | 业务类型码 |
| order_id | str  |    是    | 订单状态   |

- **请求示例:**

```python
127.0.0.1:8000/v1/orders/processing/?status=2
```

#### 2.响应:

- **返回值类型:**JSON

- **响应内容:**

  | 字段 | 含义   | 类型 | 备注                        |
  | ---- | ------ | ---- | --------------------------- |
  | code | 状态码 | int  | 默认正常为200，异常见状态码 |

- **响应格式:**

  ```python
  {"code":200}
  ```

### 7.订单支付API

#### 1.请求

- **URL：**http://127.0.0.1:8000/v1/orders/processing/

- **请求方式:**POST

- **请求参数:**

|   参数   | 类型 | 是否必须 | 说明       |
| :------: | :--: | :------: | ---------- |
|  status  | int  |    是    | 业务类型码 |
| order_id | str  |    是    | 订单id     |

- **请求示例:**

```python
http://127.0.0.1:8000/v1/orders/processing/?status=1&order_id=2019111811504601
```

#### 2.响应:

- **返回值类型:**JSON

- **响应内容:**

  | 字段  | 含义     | 类型 | 备注                        |
  | ----- | -------- | ---- | --------------------------- |
  | code  | 状态码   | int  | 默认正常为200，异常见状态码 |
  | data  | 具体数据 | dict | 与error二选一               |
  | error | 错误信息 | char | 与data二选一                |

- **响应格式:**

  ```python
  {"code":200,"data":data}
  ```

- **data参数信息:**

  |     参数     |   类型   | 是否必须 |      说明      |
  | :----------: | :------: | :------: | :------------: |
  |    saller    |   str    |    是    |    商家名称    |
  | total_amount | decimail |    是    |     总价格     |
  |   order_id   |   str    |    是    |     订单号     |
  |   pay_url    |   str    |    是    | 第三方支付路由 |

- **data数据示例:**

  ```python
     [{'saller': '达达商城',
       'total_amount': total_amount + 10,
       'order_id': order_id,
       'pay_url': pay_url
        }]
  ```

- **error参数信息:**

  |   参数    | 类型 | 是否必须 |     说明     |
  | :-------: | :--: | :------: | :----------: |
  | error_msg | str  |    是    | 错误信息说明 |

- **error数据示例:**

  ```python
   [{
       "error_msg":""
   }]
  ```

- **状态码参考:**

  | 状态码 | 响应信息 |
  | ------ | -------- |
  | 200    | 正常     |

